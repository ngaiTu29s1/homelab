version: '3.8'

services:
  ntfy:
    image: binwiederhier/ntfy
    container_name: ntfy
    command:
      - serve
    environment:
      - TZ=Asia/Ho_Chi_Minh
      - NTFY_BASE_URL=https://ntfy.tutran-dev.id.vn
      
      # [QUAN TRỌNG] Báo cho ntfy biết nó đang đứng sau Cloudflare
      # Để nó xử lý đúng IP client và WebSocket
      - NTFY_BEHIND_PROXY=true 
      
      # (Optional) Nếu người muốn bật tính năng iOS (cần upstream server)
      # - NTFY_UPSTREAM_BASE_URL=https://ntfy.sh
      
      # Cấu hình Cache để xem lại lịch sử tin nhắn
      - NTFY_CACHE_FILE=/var/lib/ntfy/cache.db
      - NTFY_ATTACHMENT_CACHE_DIR=/var/lib/ntfy/attachments
      - NTFY_KEEPALIVE_INTERVAL=45s
    volumes:
      # [SỬA LỖI] Đường dẫn chuẩn của ntfy image là /var/lib/ntfy
      # File cũ của người map vào /var/cache/ntfy là sai chỗ, nên data sẽ mất khi restart
      - ./ntfy_data:/var/lib/ntfy
      - ./ntfy_config:/etc/ntfy 
    ports:
      - "8081:80"
    networks:
      - homelab
    restart: unless-stopped

networks:
  homelab:
    external: true
